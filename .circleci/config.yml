version: 2

defaults: &defaults
  working_directory: /go/src/github.com/weaveworks/scope
  docker:
    - image: weaveworks/scope-backend-build:circle-2.0-2885645

client-defaults: &client-defaults
  working_directory: /home/weave/scope
  docker:
    - image: weaveworks/scope-ui-build:circle-2.0-2885645

workflows:
  version: 2
  test_and_deploy:
    jobs:
      - lint
      - unit-test
      - client-build
      - client-test:
          requires:
            - client-build
      - arm-build:
          requires:
            - build
      - darwin-build:
          requires:
            - build
      - build:
          requires:
            - client-build
      - integration-tests:
          requires:
            - lint
            - unit-test
            - build
      - gen-coverage:
          requires:
            - unit-test
            - integration-tests
      - deploy:
          filters:
            branches:
              only: master
          requires:
            - client-test
            - integration-tests

jobs:
  lint:
    <<: *defaults
    steps:
      - checkout
      - run: make BUILD_IN_CONTAINER=false lint

  unit-test:
    <<: *defaults
    parallelism: 1
    steps:
      - checkout
      - run: COVERDIR=./coverage make BUILD_IN_CONTAINER=false CODECGEN_UID=23 tests
      - persist_to_workspace:
          root: .
          paths:
          - coverage

  # Create client/build/index.html
  client-build:
    <<: *client-defaults
    steps:
      - checkout
      # Convoluted set of steps here to mimic Makefile actions of bind-mounting different dirs into container
      - run: |
          mv client/app /home/weave/
          cd /home/weave; mkdir build         ; yarn run build         ; mv build          scope/client
          cd /home/weave; mkdir build-external; yarn run build-external; mv build-external scope/client
      - persist_to_workspace:
          root: /home/weave/scope
          paths:
          - client/build/
          - client/build-external/

  client-test:
    <<: *client-defaults
    steps:
      - checkout
      - run: |
          mv client/app client/test /home/weave/
          cd /home/weave; yarn run lint
          cd /home/weave; yarn test

  arm-build:
    <<: *defaults
    steps:
      - checkout
      - run: GOARCH=arm make BUILD_IN_CONTAINER=false GO_BUILD_INSTALL_DEPS= prog/scope

  darwin-build:
    <<: *defaults
    steps:
      - checkout
      - run: GOOS=darwin make BUILD_IN_CONTAINER=false GO_BUILD_INSTALL_DEPS= prog/scope

  build:
    <<: *defaults
    steps:
      - checkout
      - setup_remote_docker
      - attach_workspace:
          at: .
      - run: make BUILD_IN_CONTAINER=false SUDO= static all
      - run: cd extras; make BUILD_IN_CONTAINER=false
      - run: make -C tools/runner
      - persist_to_workspace:
          root: .
          paths:
          - scope.tar
          - cloud-agent.tar
          - tools/runner/runner
          - prog/externalui/
          - prog/staticui/
          - report/report.codecgen.go
          - render/detailed/detailed.codecgen.go

  integration-tests:
    machine:
      image: circleci/classic:201709-01
    working_directory: /home/circleci/src/github.com/weaveworks/scope
    environment:
      SRCDIR: /home/circleci/src/github.com/weaveworks/scope
      CIRCLE_ARTIFACTS: /tmp/artifacts
      CLOUDSDK_CORE_DISABLE_PROMPTS: 1
    parallelism: 2
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run: |
          sudo apt-get update
          sudo apt-get install python-pip jq pv
          sudo pip install awscli
      # kick off creation of test VMs
      - run: test -z "$SECRET_PASSWORD" || bin/setup-circleci-secrets "$SECRET_PASSWORD"
      - run: test -z "$SECRET_PASSWORD" || (cd $SRCDIR/integration; ./gce.sh make_template)
      - run: test -z "$SECRET_PASSWORD" || (cd $SRCDIR/integration; ./gce.sh setup && eval $(./gce.sh hosts); ./setup.sh)
      - run: make deps; touch tools/runner/runner
      - run:
          command: test -z "$SECRET_PASSWORD" || (cd $SRCDIR/integration; eval $(./gce.sh hosts); ./run_all.sh)
          no_output_timeout: 5m
      # Destroy testing VMs:
      - run:
          command: test -z "$SECRET_PASSWORD" || (cd $SRCDIR/integration; ./gce.sh destroy)
          background: true
      - persist_to_workspace:
          root: .
          paths:
          - coverage

  gen-coverage:
    <<: *defaults
    environment:
      CIRCLE_ARTIFACTS: /tmp/artifacts
    steps:
      - checkout
      - run: mkdir $CIRCLE_ARTIFACTS
      - attach_workspace:
          at: .
      - run: ./tools/cover/gather_coverage.sh ./coverage $SRCDIR/coverage
      - run: goveralls -repotoken $COVERALLS_REPO_TOKEN -coverprofile=profile.cov -service=circleci
      - run: cp coverage.* */*.codecgen.go $CIRCLE_ARTIFACTS
      - store_artifacts:
          path: /tmp/artifacts

  deploy:
    <<: *defaults
    environment:
      IMAGES: scope cloud-agent
    steps:
      - checkout
      - setup_remote_docker
      - attach_workspace:
          at: .
      # PATH must be set here as circle currently does not support string interpolation
      # for environment
      # https://discuss.circleci.com/t/bin-sh-mkdir-command-not-found/8710
      - run: export PATH="$PATH:$HOME/.local/bin"
      - run: |
          docker load -i scope.tar
          docker load -i cloud-agent.tar
          test -z "${DOCKER_USER}" || (
            docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS &&
            (test "${DOCKER_ORGANIZATION:-$DOCKER_USER}" = "weaveworks" || (
              for IMAGE in $IMAGES; do
                docker tag weaveworks/$IMAGE:latest ${DOCKER_ORGANIZATION:-$DOCKER_USER}/$IMAGE:latest &&
                docker tag weaveworks/$IMAGE:$(./tools/image-tag) ${DOCKER_ORGANIZATION:-$DOCKER_USER}/$IMAGE:$(./tools/image-tag)
              done
            )) &&
            for IMAGE in $IMAGES; do
              docker push ${DOCKER_ORGANIZATION:-$DOCKER_USER}/$IMAGE &&
              docker push ${DOCKER_ORGANIZATION:-$DOCKER_USER}/$IMAGE:$(./tools/image-tag)
            done
          )
      - run: |
          test -z "${QUAY_USER}" || (
            docker login -e '.' -u "$QUAY_USER" -p "$QUAY_PASSWORD" quay.io &&
            docker tag weaveworks/scope:$(./tools/image-tag) "quay.io/${QUAY_ORGANIZATION}/scope:$(./tools/image-tag)" &&
            docker push "quay.io/${QUAY_ORGANIZATION}/scope:$(./tools/image-tag)"
          )
      - run: test -z "${UI_BUCKET_KEY_ID}" || (cd $SRCDIR && make ui-upload && make ui-pkg-upload)
