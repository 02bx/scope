general:
  branches:
    ignore:
      - gh-pages

machine:
  services:
    - docker
  environment:
    GOPATH: /home/ubuntu
    SRCDIR: /home/ubuntu/src/github.com/weaveworks/scope
    PATH: $PATH:$HOME/.local/bin
    CLOUDSDK_CORE_DISABLE_PROMPTS: 1
    SCOPE_UI_BUILD: $HOME/docker/scope_ui_build.tar

dependencies:
  cache_directories:
    - "~/docker"
  override:
    - >
      sudo apt-get update &&
      sudo apt-get install jq pv &&
      (curl https://sdk.cloud.google.com | bash) &&
      (test -z "$SECRET_PASSWORD" || bin/setup-circleci-secrets "$SECRET_PASSWORD") &&
      make deps &&
      mkdir -p $(dirname $SRCDIR) &&
      cp -r $(pwd)/ $SRCDIR

test:
  override:
    - >
      cd $SRCDIR;
      go get ./tools/thingdoer;
      thingdoer tasks.yml
    - >
      test "$CIRCLE_NODE_INDEX" != "0" || (
        ./tools/cover/gather_coverage.sh ./coverage $SRCDIR/coverage &&
        goveralls -repotoken $COVERALLS_REPO_TOKEN -coverprofile=$SRCDIR/profile.cov -service=circleci || true &&
        cp coverage.* scope.tar $CIRCLE_ARTIFACTS
      )

deployment:
  hub:
    branch: master
    commands:
      - >
        test -z "${DOCKER_USER}" || (
          docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS &&
          (test "${DOCKER_ORGANIZATION:-$DOCKER_USER}" == "weaveworks" || docker tag weaveworks/scope:latest ${DOCKER_ORGANIZATION:-$DOCKER_USER}/scope:latest) &&
          docker push ${DOCKER_ORGANIZATION:-$DOCKER_USER}/scope
        )
  release:
    branch: /release-[0-9]+\.[0-9]+/
    owner: weaveworks
    commands:
      - go get github.com/weaveworks/wordepress && cd /home/ubuntu/src/github.com/weaveworks/wordepress && git checkout v1.0.0 && cd cmd/wordepress && go get
      - cd $SRCDIR; PRODUCT=scope tools/publish-site "$WP_LIVE_URL" "$WP_LIVE_USER" "$WP_LIVE_PASSWORD"
  issues:
    branch: /.*/
    owner: weaveworks
    commands:
      - go get github.com/weaveworks/wordepress && cd /home/ubuntu/src/github.com/weaveworks/wordepress && git checkout v1.0.0 && cd cmd/wordepress && go get
      - cd $SRCDIR; PRODUCT=scope tools/publish-site "$WP_DEV_URL" "$WP_DEV_USER" "$WP_DEV_PASSWORD"
