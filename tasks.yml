- name: build-image
  command: >
    cd backend;
    ../tools/rebuild-image weaveworks/scope-backend-build . Dockerfile build.sh &&
    touch ../.scope_backend_build.uptodate

- name: ui-build-image
  command: >
    cd client;
    ../tools/rebuild-image weaveworks/scope-ui-build . Dockerfile package.json webpack.production.config.js .eslintrc .babelrc &&
    touch ../.scope_ui_build.uptodate

- name: vm-template
  command: test -z "$SECRET_PASSWORD" || (cd integration; ./gce.sh make_template)

- name: arm-darwin-build
  after: [build-image]
  command: >
    rm -f prog/scope;
    if [ "$CIRCLE_NODE_INDEX" = "0" ]; then
      GOARCH=arm make GO_BUILD_INSTALL_DEPS= RM= RUN_FLAGS= prog/scope;
    else
      GOOS=darwin make GO_BUILD_INSTALL_DEPS= RM= RUN_FLAGS= prog/scope;
    fi

- name: build
  after: [arm-darwin-build, ui-build-image]
  command: rm -f prog/scope; make RM= RUN_FLAGS=

- name: integration
  after: [build, vm-template]
  unless:
  command: >
    test -z "$SECRET_PASSWORD" || (
      cd integration;
      ./gce.sh setup &&
      eval $(./gce.sh hosts) &&
      ./setup.sh &&
      ./run_all.sh &&
      ./gce.sh destroy
    )

- name: lint
  after: [build-image]
  command: make RM= RUN_FLAGS= lint

- name: test
  after: [build-image]
  command: COVERDIR=./coverage make RM= RUN_FLAGS= tests

- name: client-test
  after: [ui-build-image]
  command: make RM= RUN_FLAGS= client-test static

- name: experimental
  after: [build-image]
  command: cd experimental; ./build_on_circle.sh
